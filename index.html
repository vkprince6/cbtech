<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codeboosters Tech - Leaderboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/Flip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --yellow: #FFD700;
            --violet: #9400D3;
            --orange: #FFA500;
            --dark: #1a1a2e;
            --light: #f5f5f7;
            --gradient: linear-gradient(45deg, var(--orange), var(--violet));
        }

        body {
            background-color: #2a1a2e;
            color: var(--light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            width: 100%;
            max-width: 800px;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .main-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, var(--yellow), var(--orange));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            0% { text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            100% { text-shadow: 0 0 20px rgba(255, 165, 0, 0.8); }
        }

        .leaderboard {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }

        .leaderboard-header {
            background: var(--gradient);
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr 3fr 1fr;
            font-weight: bold;
            text-align: center;
        }

        .leaderboard-body {
            min-height: 400px;
            position: relative;
        }

        .student-card {
            display: grid;
            grid-template-columns: 1fr 3fr 1fr;
            padding: 1rem;
            margin: 0.5rem;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            transition: all 0.3s ease;
            text-align: center;
        }

        .student-card:hover {
            background: rgba(255, 255, 255, 0.07);
        }

        .rank {
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rank-1 { color: var(--yellow); }
        .rank-2 { color: silver; }
        .rank-3 { color: var(--orange); }

        .student-name {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 1rem;
        }

        .student-points {
            font-weight: bold;
            background: var(--gradient);
            border-radius: 20px;
            padding: 0.3rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            width: 60px;
        }

        .file-input-container {
            margin: 1rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            background: var(--gradient);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 165, 0, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .status {
            margin: 1rem 0;
            text-align: center;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 25px;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle.active {
            background: var(--violet);
        }

        .toggle-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle.active .toggle-thumb {
            transform: translateX(25px);
        }
        
        .refresh-timer {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="main-title">Codeboosters Tech - Leaderboard</h1>
            <h2>SNS TECH - RANKING LEADERBOARD</h2>
        </header>

        <div class="leaderboard">
            <div class="leaderboard-header">
                <div>Rank</div>
                <div>Student Name</div>
                <div>Points</div>
            </div>
            <div class="leaderboard-body" id="leaderboard-body">
                <div style="padding: 2rem; text-align: center;">
                    Loading leaderboard data...
                </div>
            </div>
        </div>

        <div class="file-input-container">            
            <div class="button-group">
                <button id="refresh-btn" class="btn">
                    ðŸ”„ Refresh Data
                </button>
                
                <button id="export-btn" class="btn btn-secondary" disabled>
                    ðŸ“¤ Export to Excel
                </button>
                
                <div class="toggle-container">
                    <span>Auto Refresh:</span>
                    <div class="toggle" id="auto-refresh-toggle">
                        <div class="toggle-thumb"></div>
                    </div>
                </div>
            </div>
            
            <div class="status" id="status">Loading data...</div>
            <div id="last-updated" style="font-size: 0.8rem; opacity: 0.7;"></div>
            <div id="refresh-timer" class="refresh-timer"></div>
        </div>
    </div>

    <script>
        // DOM Elements
        const leaderboardBody = document.getElementById('leaderboard-body');
        const refreshBtn = document.getElementById('refresh-btn');
        const status = document.getElementById('status');
        const exportBtn = document.getElementById('export-btn');
        const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
        const lastUpdated = document.getElementById('last-updated');
        const refreshTimer = document.getElementById('refresh-timer');
        
        // Configuration
        const EXCEL_FILE_PATH = "./data/leaderboard.xlsx"; // Set your default path here
        
        // Variables
        let currentData = [];
        let autoRefreshInterval = null;
        let isAutoRefreshEnabled = false;
        const REFRESH_INTERVAL = 5000; // 5 seconds
        let countdownInterval = null;
        let countdownValue = REFRESH_INTERVAL / 1000;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize GSAP
            gsap.registerPlugin(Flip);
            
            // Set up event listeners
            setupEventListeners();
            
            // Load data automatically on page load
            loadExcelData();
        });
        
        function setupEventListeners() {
            // Refresh button
            refreshBtn.addEventListener('click', loadExcelData);
            
            // Export button
            exportBtn.addEventListener('click', exportToExcel);
            
            // Auto refresh toggle
            autoRefreshToggle.addEventListener('click', toggleAutoRefresh);
        }
        
        function loadExcelData() {
            status.textContent = 'Loading data...';
            status.style.color = '';
            
            // Use fetch to get the Excel file from the configured path
            fetch(EXCEL_FILE_PATH)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch file: ${response.status} ${response.statusText}`);
                    }
                    return response.arrayBuffer();
                })
                .then(data => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        // Store the current data
                        currentData = jsonData;
                        
                        // Process and display the data
                        processData(jsonData);
                        
                        // Enable export button
                        exportBtn.disabled = false;
                        
                        // Update status
                        status.textContent = 'Data loaded successfully!';
                        status.style.color = '';
                        updateLastUpdated();
                        
                    } catch (error) {
                        console.error("Error processing Excel:", error);
                        status.textContent = 'Error processing file. Please check console for details.';
                        status.style.color = 'red';
                    }
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    status.textContent = `Error loading file: ${error.message}`;
                    status.style.color = 'red';
                });
        }
        
        function processData(data) {
            // Sort by Total Points descending
            const sorted = [...data].sort((a, b) => {
                const aPoints = getPoints(a);
                const bPoints = getPoints(b);
                return bPoints - aPoints;
            });

            // Get current state for FLIP animation
            const state = Flip.getState(".student-card");
            
            // Clear existing leaderboard
            leaderboardBody.innerHTML = '';

            // Create student cards
            sorted.forEach((student, index) => {
                const card = document.createElement('div');
                card.className = 'student-card';
                
                const rankClass = index < 3 ? `rank-${index+1}` : '';
                const name = getName(student);
                const points = getPoints(student);

                card.innerHTML = `
                    <div class="rank ${rankClass}">${index + 1}</div>
                    <div class="student-name">${name}</div>
                    <div class="student-points">${points}</div>
                `;
                
                leaderboardBody.appendChild(card);
            });
            
            // Animate the changes
            Flip.from(state, {
                duration: 0.5,
                ease: "power1.out",
                absolute: true
            });
        }
        
        function exportToExcel() {
            if (currentData.length === 0) {
                status.textContent = 'No data to export!';
                status.style.color = 'red';
                return;
            }
            
            try {
                // Add ranking to the data
                const rankedData = [...currentData]
                    .sort((a, b) => getPoints(b) - getPoints(a))
                    .map((student, index) => ({
                        Rank: index + 1,
                        Name: getName(student),
                        Points: getPoints(student),
                        ...student // Include all original data
                    }));
                
                // Create a new workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(rankedData);
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, "Leaderboard");
                
                // Generate file and download
                const fileName = `leaderboard_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                status.textContent = 'Exported successfully!';
                status.style.color = '';
            } catch (error) {
                console.error("Export error:", error);
                status.textContent = 'Error exporting file. Please check console.';
                status.style.color = 'red';
            }
        }
        
        function toggleAutoRefresh() {
            isAutoRefreshEnabled = !isAutoRefreshEnabled;
            autoRefreshToggle.classList.toggle('active');
            
            if (isAutoRefreshEnabled) {
                startAutoRefresh();
                status.textContent = 'Auto refresh enabled. Refreshing data...';
                loadExcelData(); // Initial load when enabling
            } else {
                stopAutoRefresh();
                status.textContent = 'Auto refresh disabled';
                refreshTimer.textContent = '';
            }
        }
        
        function startAutoRefresh() {
            stopAutoRefresh(); // Clear any existing interval
            
            // Start countdown
            countdownValue = REFRESH_INTERVAL / 1000;
            updateCountdown();
            
            countdownInterval = setInterval(() => {
                countdownValue--;
                updateCountdown();
                
                if (countdownValue <= 0) {
                    countdownValue = REFRESH_INTERVAL / 1000;
                }
            }, 1000);
            
            // Start data refresh
            autoRefreshInterval = setInterval(() => {
                loadExcelData();
                status.textContent = 'Auto refreshing data...';
            }, REFRESH_INTERVAL);
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }
        
        function updateCountdown() {
            if (isAutoRefreshEnabled) {
                refreshTimer.textContent = `Next refresh in ${countdownValue} seconds`;
            } else {
                refreshTimer.textContent = '';
            }
        }
        
        function updateLastUpdated() {
            const now = new Date();
            lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }
        
        function getName(student) {
            // Try different possible column names for student name
            return student['Student Name'] || 
                   student['Student name'] || 
                   student.Name || 
                   student.name || 
                   student.Student || 
                   student.student || 
                   'Unknown';
        }

        function getPoints(student) {
            // Try different possible column names for points
            return student['Total Points'] || 
                   student['Total points'] || 
                   student.Points || 
                   student.points || 
                   student.Score || 
                   student.score || 
                   0;
        }
    </script>
</body>
</html>